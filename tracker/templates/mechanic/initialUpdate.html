{% extends 'base/layout.html' %}

{% load static %}

{% block css_content %}
    <link rel="stylesheet" href="{% static 'css/mechanic.css' %}">
{% endblock css_content %}


{% block content %}
    <div class="container mt-3 p-3">
        <div class="row">
            <div class="col-3">
                <h4 class="text-info p-2 border text-center">Mechanic Office Address</h4>
                {% for message in messages %}
                <div class="alert alert-danger">
                {{message}}
                </div>
                {% endfor %}
                <form action="" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_address">Address</label>
                        <input type="text" name="address" id="id_address" class="form-control" placeholder="Enter Address" required />
                    </div>
                    <div class="mb-3">
                        <label for="id_latitude">Latitude</label>
                        <input type="text" name="latitude" id="id_latitude" class="form-control" placeholder="Enter Latitude" required />
                    </div>
                    <div class="mb-3">
                        <label for="id_longitude">Latitude</label>
                        <input type="text" name="longitude" id="id_longitude" class="form-control" placeholder="Enter Longitude" required />
                    </div>
                    <button type="submit" class="btn btn-outline-success">Save</button>
                </form>
            </div>
            <div class="col-9">
                <div>
                    <form action="" id="search_address">
                        <div class="input-group mb-3">
                            <input type="text" name="search" class="form-control" placeholder="search your garage address" aria-label="Recipient's username" aria-describedby="basic-addon2" required>
                    
                                <button class="btn btn-info">Search </button>
                
                        </div>
                    </form>
                </div>
                <div id="mymap">

                </div>
            </div>
        </div>
    </div>
    <script>
        let latlng = [26.6635544183563, 87.27502087175422];
        let map = L.map('mymap').setView(latlng, 13);
        const showMap = (latlng)=>{

        }

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let marker = L.marker(latlng).addTo(map);

            
        let popup = L.popup();

        const setAddress = (latlng,address)=>{
            document.getElementById('id_address').value = address;
           
             document.getElementById("id_latitude").value = latlng.lat;
             document.getElementById("id_longitude").value = latlng.lng;
        }

        const show_popup = (latlng,dipalsy_message='')=>{
                
                if (dipalsy_message===''){
                    display_message = "loading....";
                }
                
                popup.setLatLng(latlng).setContent(dipalsy_message).openOn(map);


        }
        const onMapClick =(e)=> {
            
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e.latlng.lat}&lon=${e.latlng.lng}`;
            show_popup(e.latlng);
            
            fetch(url).then(res=>res.json()).then(json_res=>{
                 const display_name = json_res.address.city+json_res.address.amenity;
                const latlng = {
                    lat:parseFloat(json_res.lat),
                    lng:parseFloat(json_res.lon)
                }
                
                  show_popup(e.latlng,display_name);
                  setAddress(latlng,display_name);

             })
            
        }

        map.on('click', onMapClick);

        const search_address = document.getElementById("search_address");
        search_address.addEventListener("submit",e=>{
            e.preventDefault();
            const search_value = e.target.search.value;
            
            const url = `https://nominatim.openstreetmap.org/?addressdetails=1&q=${search_value}&format=json&limit=1`;
            fetch(url).then(res=>res.json()).then(json_res=>{
              
                const data = json_res[0];
               
                map.flyTo([data.lat, data.lon],15);
                const latlng = {'lat':data.lat,'lng':data.lon}
                marker.bindPopup(data.display_name).openPopup();
          
                marker.setLatLng(latlng);
            })
        })
    </script>
{% endblock content %}



